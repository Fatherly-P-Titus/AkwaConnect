
3. Updated database-schema.txt (Refactored)

```sql
-- Updated profiles table with new fields
CREATE TABLE profiles (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    username VARCHAR(50) UNIQUE NOT NULL, -- New: Unique username
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    full_name VARCHAR(255),
    dob DATE,
    gender VARCHAR(10) CHECK (gender IN ('male', 'female', 'other')),
    lga VARCHAR(100),
    city VARCHAR(100),
    hobbies TEXT[], -- Array of hobbies
    bio TEXT,
    disability_desc TEXT,
    has_disability BOOLEAN DEFAULT FALSE,
    preferred_gender VARCHAR(20) DEFAULT 'any',
    min_age_preference INTEGER DEFAULT 25,
    max_age_preference INTEGER DEFAULT 40,
    created_at TIMESTAMP DEFAULT NOW(),
    last_active TIMESTAMP DEFAULT NOW(),
    is_admin BOOLEAN DEFAULT FALSE,
    blocked_users UUID[] DEFAULT '{}',
    verified BOOLEAN DEFAULT FALSE,
    newsletter_subscribed BOOLEAN DEFAULT TRUE,
    profile_completion INTEGER DEFAULT 0 -- Percentage
);

-- New table for preferences (list-type)
CREATE TABLE user_preferences (
    id SERIAL PRIMARY KEY,
    user_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
    preference_text VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);

-- New table for demographic preferences
CREATE TABLE demographic_preferences (
    id SERIAL PRIMARY KEY,
    user_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
    demographic_type VARCHAR(50) NOT NULL, -- 'student', 'professional', 'single_parent', 'business_owner'
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(user_id, demographic_type)
);

-- Updated interactions table (no changes needed)
CREATE TABLE interactions (
    id SERIAL PRIMARY KEY,
    user_id UUID REFERENCES profiles(id),
    target_id UUID REFERENCES profiles(id),
    action VARCHAR(10), -- 'like' or 'pass'
    timestamp TIMESTAMP DEFAULT NOW(),
    UNIQUE(user_id, target_id)
);

-- Updated matches table (no changes needed)
CREATE TABLE matches (
    id SERIAL PRIMARY KEY,
    user1_id UUID REFERENCES profiles(id),
    user2_id UUID REFERENCES profiles(id),
    matched_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(user1_id, user2_id)
);

-- Messages table (no changes needed)
CREATE TABLE messages (
    id SERIAL PRIMARY KEY,
    sender_id UUID REFERENCES profiles(id),
    receiver_id UUID REFERENCES profiles(id),
    conversation_id INTEGER REFERENCES matches(id),
    content TEXT NOT NULL,
    read BOOLEAN DEFAULT FALSE,
    timestamp TIMESTAMP DEFAULT NOW(),
    created_at TIMESTAMP DEFAULT NOW()
);

-- Profile views table
CREATE TABLE profile_views (
    id SERIAL PRIMARY KEY,
    viewer_id UUID REFERENCES profiles(id),
    viewed_id UUID REFERENCES profiles(id),
    timestamp TIMESTAMP DEFAULT NOW(),
    UNIQUE(viewer_id, viewed_id)
);

-- Create indexes for performance
CREATE INDEX idx_profiles_username ON profiles(username);
CREATE INDEX idx_profiles_email ON profiles(email);
CREATE INDEX idx_profiles_lga ON profiles(lga);
CREATE INDEX idx_profiles_gender ON profiles(gender);
CREATE INDEX idx_profiles_age ON profiles(dob);
CREATE INDEX idx_profiles_created ON profiles(created_at DESC);
CREATE INDEX idx_profiles_active ON profiles(last_active DESC);
CREATE INDEX idx_profiles_admin ON profiles(is_admin);

CREATE INDEX idx_user_preferences_user ON user_preferences(user_id);
CREATE INDEX idx_demographic_preferences_user ON demographic_preferences(user_id);
CREATE INDEX idx_interactions_user ON interactions(user_id);
CREATE INDEX idx_interactions_target ON interactions(target_id);
CREATE INDEX idx_messages_conversation ON messages(conversation_id);
CREATE INDEX idx_messages_timestamp ON messages(timestamp);
CREATE INDEX idx_profile_views ON profile_views(viewed_id, timestamp);

-- Functions and Triggers
CREATE OR REPLACE FUNCTION update_last_active()
RETURNS TRIGGER AS $$
BEGIN
    NEW.last_active = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_profile_last_active
    BEFORE UPDATE ON profiles
    FOR EACH ROW
    EXECUTE FUNCTION update_last_active();

-- Function to calculate age from DOB
CREATE OR REPLACE FUNCTION calculate_age(dob DATE)
RETURNS INTEGER AS $$
BEGIN
    RETURN EXTRACT(YEAR FROM AGE(NOW(), dob));
END;
$$ LANGUAGE plpgsql;

-- View for user profiles with calculated age
CREATE VIEW user_profiles_view AS
SELECT 
    id,
    username,
    email,
    full_name,
    calculate_age(dob) as age,
    gender,
    lga,
    city,
    hobbies,
    bio,
    has_disability,
    disability_desc,
    preferred_gender,
    min_age_preference,
    max_age_preference,
    created_at,
    last_active
FROM profiles;

-- Insert initial admin user (replace with actual password hash)
INSERT INTO profiles (username, email, password_hash, full_name, is_admin, verified)
VALUES (
    'admin', 
    'fatherlytitus69@gmail.com', 
    '$2a$10$your_hashed_password_here', -- Replace with actual hash
    'Admin User', 
    TRUE, 
    TRUE
);